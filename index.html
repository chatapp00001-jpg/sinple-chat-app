<!doctype html>
<html lang="en">
<head>
<link rel="icon" href="chat.png" type="image/png" />
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Easy Chat</title>

<style>
body{
  font-family: Inter, system-ui, Arial;
  background:#f5f7fb;
  margin:0;
  padding:16px;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
body.dark{background:#121212;color:#e0e0e0}
.app{
  width:100%;
  max-width:720px;
  background:#fff;
  border-radius:12px;
  box-shadow:0 6px 30px rgba(0,0,0,.1);
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
body.dark .app{background:#1e1e1e}
header{padding:12px;border-bottom:1px solid #ddd}
#messages{
  height:55vh;
  overflow:auto;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.msg{
  background:#eef6ff;
  padding:8px 10px;
  border-radius:8px;
  max-width:75%;
}
.me{align-self:flex-end;background:#dff6e8}
.reply-box{
  background:#000;
  color:#fff;
  padding:4px 6px;
  font-size:12px;
  border-radius:6px;
  margin-bottom:4px;
}
footer{
  padding:12px;
  border-top:1px solid #ddd;
  display:flex;
  flex-direction:column;
  gap:6px;
}
input,button{
  padding:8px;
  border-radius:6px;
  border:1px solid #ccc;
}
button{
  background:#2563eb;
  color:#fff;
  cursor:pointer;
}
button:disabled{background:#999}
.online-list{font-size:12px;display:flex;gap:6px;flex-wrap:wrap}
.avatar{
  width:20px;
  height:20px;
  border-radius:50%;
  display:inline-block;
}
</style>
</head>

<body>
<div class="app">
<header>
  <strong>Easy Chat</strong><br>
  Name: <span id="displayName">(not set)</span> |
  Room: <span id="roomName">global</span>
  <div class="online-list" id="onlineUsers"></div>
</header>

<div id="messages"></div>

<footer>
  <input id="nameInput" placeholder="Your name">
  <input id="roomInput" placeholder="Room name">
  <input id="msgInput" placeholder="Type a message">
  <button id="sendBtn">Send</button>
</footer>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB1kH5ViWhVpwJMaQEY0mcJhtEOia1k2aE",
  authDomain: "chat-2d825.firebaseapp.com",
  databaseURL: "https://chat-2d825-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "chat-2d825",
  storageBucket: "chat-2d825.appspot.com",
  messagingSenderId: "397345569962",
  appId: "1:397345569962:web:bac031c0cf9a394820a4d3"
};
firebase.initializeApp(firebaseConfig);

const db = firebase.database();
const auth = firebase.auth();

const msgInput=document.getElementById('msgInput');
const nameInput=document.getElementById('nameInput');
const roomInput=document.getElementById('roomInput');
const messagesEl=document.getElementById('messages');
const displayNameEl=document.getElementById('displayName');
const roomNameEl=document.getElementById('roomName');
const sendBtn=document.getElementById('sendBtn');
const onlineUsersEl=document.getElementById('onlineUsers');

let uid=null;
let displayName=localStorage.getItem('displayName')||'';
let roomName=localStorage.getItem('roomName')||'global';

let nameAllowed=true;
let nameRef=null;

nameInput.value=displayName;
roomInput.value=roomName;
displayNameEl.textContent=displayName||'(not set)';
roomNameEl.textContent=roomName;

auth.onAuthStateChanged(u=>{
  if(!u) auth.signInAnonymously();
  else uid=u.uid;
});

function colorForId(id){
  const c=['#ef4444','#3b82f6','#10b981','#8b5cf6'];
  let h=0;for(let i=0;i<id.length;i++)h=id.charCodeAt(i)+((h<<5)-h);
  return c[Math.abs(h)%c.length];
}

/* ðŸ”‘ UNIQUE NAME CHECK */
function checkUniqueName(room,name){
  if(!uid||!name)return;
  if(nameRef)nameRef.off();

  nameRef=db.ref(`roomNames/${room}/${name}`);
  nameRef.on('value',snap=>{
    if(!snap.exists() || snap.val()===uid){
      nameAllowed=true;
      msgInput.disabled=false;
      sendBtn.disabled=false;
      msgInput.placeholder="Type a message";
    }else{
      nameAllowed=false;
      msgInput.disabled=true;
      sendBtn.disabled=true;
      msgInput.placeholder="âš  Name already used. Change name.";
    }
  });
}

/* NAME CHANGE */
nameInput.addEventListener('change',()=>{
  const n=nameInput.value.trim();
  if(!n||!uid)return;

  displayName=n;
  displayNameEl.textContent=n;
  localStorage.setItem('displayName',n);

  checkUniqueName(roomName,n);

  db.ref(`roomNames/${roomName}/${n}`).transaction(cur=>{
    if(cur===null||cur===uid)return uid;
  });

  db.ref(`presence/${roomName}/${uid}`).set({name:n});
});

/* ROOM CHANGE */
roomInput.addEventListener('change',()=>{
  roomName=roomInput.value.trim()||'global';
  roomNameEl.textContent=roomName;
  localStorage.setItem('roomName',roomName);
  listenRoom(roomName);
  watchPresence(roomName);
  if(displayName)checkUniqueName(roomName,displayName);
});

/* SEND MESSAGE */
function sendMessage(){
  if(!nameAllowed){
    alert("Name already used in this room");
    return;
  }
  const text=msgInput.value.trim();
  if(!text||!uid)return;
  db.ref(`rooms/${roomName}/messages`).push({
    name:displayName||'Anonymous',
    text,uid,ts:Date.now()
  });
  msgInput.value='';
}

sendBtn.onclick=sendMessage;
msgInput.onkeydown=e=>{if(e.key==="Enter")sendMessage();};

/* MESSAGES */
function listenRoom(room){
  messagesEl.innerHTML='';
  db.ref(`rooms/${room}/messages`).limitToLast(100)
  .on('child_added',snap=>{
    const m=snap.val();
    const div=document.createElement('div');
    div.className='msg'+(m.uid===uid?' me':'');
    div.innerHTML=`<b>${m.name}</b><br>${m.text}`;
    messagesEl.appendChild(div);
    messagesEl.scrollTop=messagesEl.scrollHeight;
  });
}

/* ONLINE USERS */
function watchPresence(room){
  db.ref(`presence/${room}`).on('value',snap=>{
    onlineUsersEl.innerHTML='';
    Object.values(snap.val()||{}).forEach(u=>{
      const d=document.createElement('div');
      const a=document.createElement('span');
      a.className='avatar';
      a.style.background=colorForId(u.name);
      d.appendChild(a);
      d.appendChild(document.createTextNode(u.name));
      onlineUsersEl.appendChild(d);
    });
  });
}

listenRoom(roomName);
watchPresence(roomName);
</script>
</body>
</html>
