<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simple Chat (Firebase) — Enhanced</title>
  <style>
    body{font-family:Inter,system-ui,Arial;background:#f5f7fb;margin:0;padding:16px;display:flex;align-items:center;justify-content:center;min-height:100vh}
    .app{width:100%;max-width:720px;background:#fff;border-radius:12px;box-shadow:0 6px 30px rgba(20,30,60,.08);display:flex;flex-direction:column;overflow:hidden}
    header{padding:12px 16px;border-bottom:1px solid #eef2f7;display:flex;align-items:center;gap:12px}
    header h1{font-size:16px;margin:0}
    .meta-bar{margin-left:auto;text-align:right}
    #messages{height:60vh;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:8px;background:linear-gradient(180deg,#f9fbff,#fff)}
    .msg{max-width:75%;padding:10px 12px;border-radius:10px;background:#eef6ff;border:1px solid rgba(0,60,120,.04);box-shadow:0 1px 0 rgba(0,0,0,.02)}
    .me{align-self:flex-end;background:#dff6e8;border-color:rgba(0,120,60,.06)}
    .meta{font-size:12px;opacity:.7;margin-bottom:6px}
    footer{padding:12px;border-top:1px solid #eef2f7;display:flex;gap:8px;align-items:flex-end}
    input[type=text]{flex:1;padding:10px 12px;border-radius:8px;border:1px solid #e6edf6}
    button{padding:10px 12px;border-radius:8px;border:none;background:#2563eb;color:#fff;cursor:pointer}
    .small{font-size:12px;color:#6b7280}
    .controls{display:flex;gap:8px;align-items:center}
    .typing{font-size:13px;color:#475569;padding:8px 12px}
    .online-list{font-size:12px;color:#374151}
    .avatar{width:28px;height:28px;border-radius:50%;display:inline-block;margin-right:8px;vertical-align:middle}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Simple Chat — Enhanced</h1>
      <div class="meta-bar">
        <div class="small">Local: <strong id="displayName">(not set)</strong></div>
        <div class="small">Room: <strong id="roomName">global</strong></div>
        <div class="online-list">Online: <span id="onlineCount">0</span></div>
        <div class="typing" id="typingEl" style="display:none">typing...</div>
      </div>
    </header>

    <div id="messages"></div>

    <footer>
      <div style="display:flex;gap:8px;flex:1;align-items:center">
        <input id="nameInput" type="text" placeholder="Your display name (e.g. Sudu)" />
        <input id="roomInput" type="text" placeholder="Room name (default: global)" />
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <input id="msgInput" type="text" placeholder="Type a message and press Enter" style="min-width:220px" />
        <div style="display:flex;gap:6px"><button id="sendBtn">Send</button><button id="clearBtn" style="background:#ef4444">Clear</button></div>
      </div>
    </footer>
  </div>

  <!-- Firebase JS (compat) CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <script>
    /***** PASTE YOUR firebaseConfig from Firebase console (include databaseURL) *****/
const firebaseConfig = {
  apiKey: "AIzaSyB1kH5ViWhVpwJMaQEY0mcJhtEOia1k2aE",
  authDomain: "chat-2d825.firebaseapp.com",
  databaseURL: "https://chat-2d825-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "chat-2d825",
  storageBucket: "chat-2d825.appspot.com", // correct format
  messagingSenderId: "397345569962",
  appId: "1:397345569962:web:bac031c0cf9a394820a4d3",
  measurementId: "G-YVDC4J0CM5"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();


    // DOM
    const msgInput = document.getElementById('msgInput');
    const nameInput = document.getElementById('nameInput');
    const roomInput = document.getElementById('roomInput');
    const messagesEl = document.getElementById('messages');
    const displayNameEl = document.getElementById('displayName');
    const roomNameEl = document.getElementById('roomName');
    const sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');
    const typingEl = document.getElementById('typingEl');
    const onlineCountEl = document.getElementById('onlineCount');

    // state
    let displayName = localStorage.getItem('displayName') || '';
    let roomName = localStorage.getItem('roomName') || 'global';
    nameInput.value = displayName;
    roomInput.value = roomName;
    displayNameEl.textContent = displayName || '(not set)';
    roomNameEl.textContent = roomName;

    // helper: deterministic color for a uid
    function colorForId(id){
      const colors = ['#f97316','#ef4444','#06b6d4','#8b5cf6','#10b981','#3b82f6','#ef9a7a','#f43f5e'];
      let h=0; for(let i=0;i<id.length;i++) h = (h<<5) - h + id.charCodeAt(i);
      return colors[Math.abs(h) % colors.length];
    }

    // presence & typing helpers
    let uid = null;
    let typingTimeout = null;

 auth.onAuthStateChanged(user => {
  if (!user) {
    auth.signInAnonymously().catch(err => console.error('Auth failed', err));
    return;
  }
  uid = user.uid;
  console.log('Signed in as', uid);
});


    // Update presence when room changes
    function setupPresence(room){
      const conRef = db.ref('.info/connected');
      conRef.on('value', snap => {
        if(!snap.val()) return; // not connected
        const pRef = db.ref('presence/' + room + '/' + uid);
        pRef.set({name: nameInput.value || 'Anonymous', ts: Date.now()});
        pRef.onDisconnect().remove();
      });
    }

    // watch presence
    function watchPresence(room){
      const pRef = db.ref('presence/' + room);
      pRef.on('value', snap => {
        const val = snap.val() || {};
        const count = Object.keys(val).length;
        onlineCountEl.textContent = count;
      });
    }

    // typing system
    function startTyping(){
      if(!uid) return;
      const tRef = db.ref('typing/' + roomName + '/' + uid);
      tRef.set({name: nameInput.value || 'Anonymous', ts: Date.now()});
      if(typingTimeout) clearTimeout(typingTimeout);
      typingTimeout = setTimeout(()=>{
        tRef.remove();
      }, 1500);
    }

    function watchTyping(room){
      const tRef = db.ref('typing/' + room);
      tRef.on('value', snap => {
        const val = snap.val() || {};
        const names = Object.values(val).map(x=>x.name).filter(Boolean);
        if(names.length>0){
          typingEl.style.display = 'block';
          typingEl.textContent = names.join(', ') + ' typing...';
        } else {
          typingEl.style.display = 'none';
        }
      });
    }

    // send message
 function sendMessage() {
  const text = msgInput.value.trim();
  if(!text) return;

  if(!uid) {
    console.error("User not authenticated yet");
    return;
  }

  const name = nameInput.value.trim() || 'Anonymous';
  const room = roomInput.value.trim() || 'global';

  const payload = { name: name, text: text, ts: Date.now(), uid: uid };
  db.ref('rooms/' + room + '/messages').push(payload)
    .then(() => {
      console.log('Message sent!', payload);
      msgInput.value = '';
      db.ref('typing/' + room + '/' + uid).remove();
    })
    .catch(err => console.error('Failed to send message:', err));
}



    sendBtn.addEventListener('click', sendMessage);
    msgInput.addEventListener('keydown', e => { if(e.key==='Enter') sendMessage(); else startTyping(); });
    msgInput.addEventListener('input', startTyping);

    // listen messages
    let currentMsgRef = null;
    function listenRoom(room){
      messagesEl.innerHTML='';
      if(currentMsgRef) currentMsgRef.off();
      currentMsgRef = db.ref('rooms/' + room + '/messages').limitToLast(200);
      currentMsgRef.on('child_added', snapshot => {
        const m = snapshot.val();
        const el = document.createElement('div');
        const u = m.uid || m.name || '';
        const isMe = (m.uid && uid && m.uid===uid) || (m.name===displayName);
        el.className = 'msg' + (isMe? ' me' : '');
        // avatar circle using color
        const color = colorForId(String(u));
        el.innerHTML = `<div class="meta"><span class="avatar" style="background:${color}"></span> <strong>${escapeHtml(m.name||'Anonymous')}</strong> · ${new Date(m.ts).toLocaleTimeString()}</div><div>${escapeHtml(m.text)}</div>`;
        messagesEl.appendChild(el);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });
    }

    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    listenRoom(roomName);

    // room & name change
    roomInput.addEventListener('change', ()=>{
      roomName = roomInput.value.trim() || 'global';
      localStorage.setItem('roomName', roomName);
      roomNameEl.textContent = roomName;
      setupPresence(roomName);
      listenRoom(roomName);
      watchPresence(roomName);
      watchTyping(roomName);
    });

    nameInput.addEventListener('change', ()=>{
      displayName = nameInput.value.trim() || 'Anonymous';
      localStorage.setItem('displayName', displayName);
      displayNameEl.textContent = displayName;
      // update presence name if present
      if(uid) db.ref('presence/' + roomName + '/' + uid).update({name: displayName});
    });

    // clear UI only
    clearBtn.addEventListener('click', ()=>{ messagesEl.innerHTML=''; });

  </script>
</body>
</html>
