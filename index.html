<!doctype html>
<html lang="en">
<head>
  <link rel="icon" href="chat.png" type="image/png" />
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Easy Chat</title>

<style>
body{font-family:Inter,system-ui,Arial;background:#f5f7fb;margin:0;padding:16px;display:flex;justify-content:center;min-height:100vh}
.app{width:100%;max-width:720px;background:#fff;border-radius:12px;box-shadow:0 6px 30px rgba(0,0,0,.1);display:flex;flex-direction:column;overflow:hidden}
header,footer{padding:12px;border-bottom:1px solid #eee}
footer{border-top:1px solid #eee;border-bottom:none}
#messages{height:55vh;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px}
.msg{max-width:75%;padding:10px;border-radius:8px;background:#eef6ff}
.me{align-self:flex-end;background:#dff6e8}
.meta{font-size:11px;opacity:.7}
.online-user{cursor:pointer;font-size:12px;margin-right:8px;display:flex;align-items:center;gap:4px}
.avatar{width:20px;height:20px;border-radius:50%}
input,button{padding:8px;border-radius:6px;border:1px solid #ccc}
button{background:#2563eb;color:#fff;cursor:pointer}
</style>
</head>

<body>
<div class="app">
<header>
  <strong id="roomName">global</strong>
  <div id="onlineUsers"></div>
</header>

<div id="messages"></div>

<footer>
  <input id="nameInput" placeholder="Your name">
  <input id="msgInput" placeholder="Type message">
  <button id="sendBtn">Send</button>
</footer>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig={
  apiKey:"AIzaSyB1kH5ViWhVpwJMaQEY0mcJhtEOia1k2aE",
  databaseURL:"https://chat-2d825-default-rtdb.asia-southeast1.firebasedatabase.app"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();
const auth=firebase.auth();

const msgInput=document.getElementById('msgInput');
const nameInput=document.getElementById('nameInput');
const messagesEl=document.getElementById('messages');
const onlineUsersEl=document.getElementById('onlineUsers');
const roomNameEl=document.getElementById('roomName');
const sendBtn=document.getElementById('sendBtn');

let uid=null;
let room="global";

/* ---------- helpers ---------- */
function timeAgo(ts){
  if(!ts) return '';
  const d=Date.now()-ts;
  const m=Math.floor(d/60000);
  if(m<1) return 'just now';
  if(m<60) return m+' min ago';
  return Math.floor(m/60)+' hr ago';
}
function privateRoomId(a,b){return a<b?a+'_'+b:b+'_'+a;}
function color(id){
  const c=['#f97316','#06b6d4','#8b5cf6','#10b981','#ef4444'];
  let h=0; for(let i of id) h+=i.charCodeAt(0);
  return c[h%c.length];
}

/* ---------- auth ---------- */
auth.onAuthStateChanged(u=>{
  if(!u) auth.signInAnonymously();
  else{ uid=u.uid; setupPresence(); listenRoom(); }
});

/* ---------- presence + last seen ---------- */
function setupPresence(){
  const c=db.ref('.info/connected');
  c.on('value',s=>{
    if(!s.val()) return;
    const p=db.ref('presence/'+room+'/'+uid);
    p.set({
      uid,
      name:nameInput.value||'Anonymous',
      online:true,
      lastSeen:firebase.database.ServerValue.TIMESTAMP
    });
    p.onDisconnect().update({
      online:false,
      lastSeen:firebase.database.ServerValue.TIMESTAMP
    });
  });
}

function watchPresence(){
  db.ref('presence/'+room).on('value',s=>{
    onlineUsersEl.innerHTML='';
    const v=s.val()||{};
    Object.values(v).forEach(u=>{
      if(!u.uid) return;
      const d=document.createElement('div');
      d.className='online-user';

      const av=document.createElement('span');
      av.className='avatar';
      av.style.background=color(u.uid);

      const t=document.createElement('span');
      t.innerHTML=`<strong>${u.name}</strong><br>
      <small>${u.online?'‚óè Online':'Last seen '+timeAgo(u.lastSeen)}</small>`;

      d.append(av,t);
      d.onclick=()=>{
        if(u.uid===uid) return;
        room='private_'+privateRoomId(uid,u.uid);
        roomNameEl.textContent='üîí Private Chat';
        listenRoom();
      };
      onlineUsersEl.appendChild(d);
    });
  });
}

/* ---------- messaging ---------- */
function sendMessage(){
  if(!msgInput.value) return;
  db.ref('rooms/'+room+'/messages').push({
    uid,
    name:nameInput.value||'Anonymous',
    text:msgInput.value,
    ts:Date.now()
  });
  msgInput.value='';
}

function render(s){
  const m=s.val();
  const d=document.createElement('div');
  d.className='msg'+(m.uid===uid?' me':'');
  d.innerHTML=`
    <div class="meta">${m.name} ¬∑ ${new Date(m.ts).toLocaleTimeString()}</div>
    ${m.text}
    ${m.uid===uid && m.seenBy ? '<span style="font-size:11px"> ‚úî‚úî</span>' : ''}
  `;
  messagesEl.appendChild(d);
  messagesEl.scrollTop=messagesEl.scrollHeight;

  // mark seen
  if(m.uid!==uid){
    db.ref('rooms/'+room+'/messages/'+s.key+'/seenBy/'+uid).set(true);
  }
}

function listenRoom(){
  messagesEl.innerHTML='';
  const r=db.ref('rooms/'+room+'/messages');
  r.off();
  r.on('child_added',render);
  watchPresence();
}

/* ---------- events ---------- */
sendBtn.onclick=sendMessage;
msgInput.onkeydown=e=>{if(e.key==='Enter') sendMessage();};
</script>
</body>
</html>
