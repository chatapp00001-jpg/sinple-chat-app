<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Easy Chat</title>

<style>
  body {
    font-family: Inter, system-ui, Arial;
    background: #f5f7fb;
    margin: 0;
    padding: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    transition: background 0.3s, color 0.3s;
  }
  body.dark { background:#121212; color:#e0e0e0; }

  .app {
    width:100%; max-width:720px;
    background:#fff; border-radius:12px;
    box-shadow:0 6px 30px rgba(20,30,60,.08);
    display:flex; flex-direction:column;
    overflow:hidden; margin:0 8px;
  }
  body.dark .app { background:#1e1e1e; }

  header {
    padding:12px 16px; border-bottom:1px solid #eef2f7;
    display:flex; flex-direction:column; gap:8px;
  }
  body.dark header { border-color:#333; }

  #messages {
    height:60vh; overflow:auto; padding:16px;
    display:flex; flex-direction:column; gap:12px;
    background:linear-gradient(180deg,#f9fbff,#fff);
  }
  body.dark #messages {
    background:linear-gradient(180deg,#2a2a2a,#1e1e1e);
  }

  .msg {
    max-width:75%; padding:10px 12px;
    border-radius:10px;
    background:#eef6ff;
    border:1px solid rgba(0,60,120,.04);
  }
  body.dark .msg { background:#2a2a2a; }

  .me { align-self:flex-end; background:#dff6e8; }
  body.dark .me { background:#3a3a3a; }

  .meta { font-size:12px; opacity:.7; margin-bottom:6px; }
  .avatar { width:28px; height:28px; border-radius:50%; display:inline-block; margin-right:8px; }

  footer { padding:12px; border-top:1px solid #eef2f7; display:flex; flex-direction:column; gap:8px; }
  body.dark footer { border-color:#333; }

  input[type=text], button {
    padding:10px 12px; border-radius:8px;
    border:1px solid #e6edf6; font-size:14px;
  }
  body.dark input[type=text], body.dark button {
    background:#2a2a2a; color:#e0e0e0; border-color:#555;
  }

  #uploadBtn {
    padding:8px 10px; font-size:18px;
    cursor:pointer;
  }

  img.chat-img {
    max-width:220px; border-radius:10px;
  }
  video.chat-video, audio.chat-audio {
    max-width:260px; border-radius:10px;
  }

</style>
</head>

<body>
<div class="app">
  <header>
    <h1>Easy Chat</h1>
    <div style="display:flex;flex-wrap:wrap;gap:12px;font-size:12px">
      Name: <strong id="displayName">(not set)</strong>
      Room: <strong id="roomName">global</strong>
      Online: <span id="onlineCount">0</span>
      <div id="typingEl" style="display:none">typing...</div>
      <button id="darkModeBtn" style="margin-left:auto">ðŸŒ™ Dark Mode</button>
    </div>
  </header>

  <div id="messages"></div>

  <footer>
    <div style="display:flex;gap:8px">
      <input id="nameInput" type="text" placeholder="Your display name">
      <input id="roomInput" type="text" placeholder="Room (default: global)">
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <input id="msgInput" type="text" placeholder="Type message">
      <button id="uploadBtn">ðŸ“Ž</button>
      <input id="fileInput" type="file" accept="image/*,video/*,audio/*" style="display:none">
      <button id="sendBtn">Send</button>
    </div>

    <button id="clearBtn" style="background:#ef4444;color:white">Clear</button>
  </footer>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB1kH5ViWhVpwJMaQEY0mcJhtEOia1k2aE",
  authDomain: "chat-2d825.firebaseapp.com",
  databaseURL: "https://chat-2d825-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "chat-2d825",
  storageBucket: "chat-2d825.appspot.com",
  messagingSenderId: "397345569962",
  appId: "1:397345569962:web:bac031c0cf9a394820a4d3"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();
const auth = firebase.auth();

// Elements
const msgInput = document.getElementById("msgInput");
const nameInput = document.getElementById("nameInput");
const roomInput = document.getElementById("roomInput");
const messagesEl = document.getElementById("messages");
const fileInput = document.getElementById("fileInput");
const uploadBtn = document.getElementById("uploadBtn");

let uid = null;

// LOGIN
auth.signInAnonymously().then(res => uid = res.user.uid);

// Upload Button -> open hidden input
uploadBtn.addEventListener("click", () => fileInput.click());

// When File Selected
fileInput.addEventListener("change", async () => {
  const file = fileInput.files[0];
  if(!file || !uid) return;

  const room = roomInput.value.trim() || "global";
  const ref = storage.ref(`uploads/${room}/${Date.now()}_${file.name}`);

  await ref.put(file);
  const url = await ref.getDownloadURL();

  let type = "file";
  if(file.type.startsWith("image")) type = "image";
  else if(file.type.startsWith("video")) type = "video";
  else if(file.type.startsWith("audio")) type = "audio";

  const payload = {
    name: nameInput.value || "Anonymous",
    uid, ts: Date.now(),
    type, url
  };

  db.ref("rooms/"+room+"/messages").push(payload);
});

// Send message
document.getElementById("sendBtn").onclick = sendMessage;
msgInput.addEventListener("keydown", e => { if(e.key==="Enter") sendMessage(); });

function sendMessage(){
  const text = msgInput.value.trim();
  if(!text || !uid) return;

  const room = roomInput.value.trim() || "global";
  const msg = {
    name: nameInput.value || "Anonymous",
    uid,
    ts: Date.now(),
    type: "text",
    text
  };

  db.ref("rooms/"+room+"/messages").push(msg);
  msgInput.value = "";
}

// LISTEN messages
function listen(room){
  messagesEl.innerHTML = "";
  db.ref("rooms/"+room+"/messages").on("child_added", snap => {
    const m = snap.val();
    const isMe = (m.uid === uid);
    const div = document.createElement("div");
    div.className = "msg" + (isMe?" me":"")

    // metadata
    let meta = `<div class="meta"><strong>${m.name}</strong> Â· ${new Date(m.ts).toLocaleTimeString()}</div>`;

    let body = "";

    if(m.type==="text"){
      body = `<div>${m.text}</div>`;
    }
    if(m.type==="image"){
      body = `<img class='chat-img' src="${m.url}">`;
    }
    if(m.type==="video"){
      body = `<video class='chat-video' controls src="${m.url}"></video>`;
    }
    if(m.type==="audio"){
      body = `<audio class='chat-audio' controls src="${m.url}"></audio>`;
    }

    div.innerHTML = meta + body;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  });
}

listen("global");

roomInput.addEventListener("change", ()=>{
  listen(roomInput.value.trim() || "global");
});

// Clear chat
document.getElementById("clearBtn").onclick = ()=> messagesEl.innerHTML="";

// Dark Mode
const darkBtn = document.getElementById("darkModeBtn");
if(localStorage.getItem("dark")==="1") document.body.classList.add("dark");

darkBtn.onclick = ()=>{
  document.body.classList.toggle("dark");
  localStorage.setItem("dark", document.body.classList.contains("dark")?"1":"0");
};
</script>

</body>
</html>
