<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Easy Chat with Unique Users</title>
<style>
body { font-family: Inter, system-ui, Arial; background:#f5f7fb; margin:0; padding:16px; display:flex; align-items:center; justify-content:center; min-height:100vh; transition:0.3s;}
body.dark { background:#121212; color:#e0e0e0; }
.app { width:100%; max-width:720px; background:#fff; border-radius:12px; box-shadow:0 6px 30px rgba(20,30,60,.08); display:flex; flex-direction:column; overflow:hidden; margin:0 8px; transition:0.3s;}
body.dark .app { background:#1e1e1e; box-shadow:0 6px 30px rgba(0,0,0,.5);}
header { padding:12px 16px; border-bottom:1px solid #eef2f7; display:flex; flex-direction:column; gap:8px; transition:0.3s;}
body.dark header { border-color:#333; color:#e0e0e0; }
header h1 { font-size:16px; margin:0;}
.meta-bar { display:flex; flex-wrap:wrap; gap:8px; font-size:12px; text-align:left;}
#messages { height:50vh; overflow:auto; padding:16px; display:flex; flex-direction:column; gap:8px; background:linear-gradient(180deg,#f9fbff,#fff);}
body.dark #messages { background:linear-gradient(180deg,#2a2a2a,#1e1e1e);}
.msg { max-width:75%; padding:10px 12px; border-radius:10px; background:#eef6ff; border:1px solid rgba(0,60,120,.04); box-shadow:0 1px 0 rgba(0,0,0,.02); word-wrap:break-word; position:relative; cursor:pointer; transition:0.3s;}
body.dark .msg { background:#2a2a2a; border-color:rgba(255,255,255,.1); color:#e0e0e0;}
.me { align-self:flex-end; background:#dff6e8; border-color: rgba(0,120,60,.06);}
body.dark .me { background:#3a3a3a; border-color: rgba(255,255,255,.2);}
.meta { font-size:12px; opacity:.7; margin-bottom:6px;}
.reply-box { background:#000; color:#fff; padding:6px 10px; border-radius:8px; font-size:12px; margin-bottom:4px;}
footer { padding:12px; border-top:1px solid #eef2f7; display:flex; flex-direction:column; gap:8px; transition:0.3s;}
body.dark footer { border-color:#333;}
footer>div { display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
input[type=text], button { flex:1; padding:10px 12px; border-radius:8px; border:1px solid #e6edf6; min-width:100px; transition:0.3s;}
body.dark input[type=text], body.dark button { background:#2a2a2a; color:#e0e0e0; border-color:rgba(255,255,255,.2);}
button { background:#2563eb; color:#fff; cursor:pointer;}
.small { font-size:12px; color:#6b7280;}
body.dark .small { color:#c0c0c0;}
.typing { font-size:13px; color:#475569; padding:8px 12px;}
body.dark .typing { color:#aaa;}
.online-list { font-size:12px; color:#374151;}
body.dark .online-list { color:#c0c0c0;}
.avatar { width:28px; height:28px; border-radius:50%; display:inline-block; margin-right:8px; vertical-align:middle;}
#onlineUsers { margin-top:6px; display:flex; flex-wrap:wrap; gap:6px;}
.user-avatar { display:flex; align-items:center; gap:4px; font-size:12px;}
.user-avatar span { width:20px; height:20px; border-radius:50%; display:inline-block;}
@media (max-width:480px){#messages{height:40vh;padding:8px;} input[type=text], button{font-size:14px; padding:8px 10px;} .msg{max-width:100%; font-size:14px;} .avatar{width:24px;height:24px;}}
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>Easy Chat</h1>
    <div class="meta-bar">
      <div class="small">Name: <strong id="displayName">(not set)</strong></div>
      <div class="small">Room: <strong id="roomName">global</strong></div>
      <div class="online-list">Online:</div>
      <div id="onlineUsers"></div>
      <div class="typing" id="typingEl" style="display:none">is typing...</div>
      <button id="darkModeBtn" style="margin-left:auto;">üåô Dark Mode</button>
    </div>
  </header>

  <div id="messages"></div>

  <footer>
    <div style="display:flex;gap:8px;flex:1;align-items:center">
      <input id="nameInput" type="text" placeholder="Your display name" />
      <input id="roomInput" type="text" placeholder="Room name (default: global)" />
    </div>
    <div style="display:flex;flex-direction:column;gap:8px">
      <input id="msgInput" type="text" placeholder="Type a message and press Enter" />
      <div style="display:flex;gap:6px">
        <button id="sendBtn">Send</button>
        <button id="clearBtn" style="background:#ef4444">Clear</button>
      </div>
    </div>
  </footer>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB1kH5ViWhVpwJMaQEY0mcJhtEOia1k2aE",
  authDomain: "chat-2d825.firebaseapp.com",
  databaseURL: "https://chat-2d825-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "chat-2d825",
  storageBucket: "chat-2d825.appspot.com",
  messagingSenderId: "397345569962",
  appId: "1:397345569962:web:bac031c0cf9a394820a4d3",
  measurementId: "G-YVDC4J0CM5"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();
const auth=firebase.auth();

const msgInput=document.getElementById('msgInput');
const nameInput=document.getElementById('nameInput');
const roomInput=document.getElementById('roomInput');
const messagesEl=document.getElementById('messages');
const displayNameEl=document.getElementById('displayName');
const roomNameEl=document.getElementById('roomName');
const sendBtn=document.getElementById('sendBtn');
const clearBtn=document.getElementById('clearBtn');
const typingEl=document.getElementById('typingEl');
const onlineUsersEl=document.getElementById('onlineUsers');
const darkModeBtn=document.getElementById('darkModeBtn');

let displayName=localStorage.getItem('displayName')||'';
let roomName=localStorage.getItem('roomName')||'global';
let uid=null;
let typingTimeout=null;
let replyTo=null;
let editKey=null;

nameInput.value=displayName;
roomInput.value=roomName;
displayNameEl.textContent=displayName||'(not set)';
roomNameEl.textContent=roomName;

if(localStorage.getItem('darkMode')==='true'){document.body.classList.add('dark');darkModeBtn.textContent='‚òÄÔ∏è Light Mode';}
darkModeBtn.addEventListener('click',()=>{
  document.body.classList.toggle('dark');
  const isDark=document.body.classList.contains('dark');
  localStorage.setItem('darkMode',isDark);
  darkModeBtn.textContent=isDark?'‚òÄÔ∏è Light Mode':'üåô Dark Mode';
});

function colorForId(id){
  const colors=['#f97316','#ef4444','#06b6d4','#8b5cf6','#10b981','#3b82f6','#ef9a7a','#f43f5e'];
  let h=0; for(let i=0;i<id.length;i++) h=(h<<5)-h+id.charCodeAt(i);
  return colors[Math.abs(h)%colors.length];
}

auth.onAuthStateChanged(user=>{if(!user) auth.signInAnonymously(); else {uid=user.uid; joinRoom();}});

async function joinRoom(){
  const roomRef=db.ref(`rooms/${roomName}`);
  const usersSnap=await roomRef.child('users').get();
  const users=usersSnap.val()||{};
  if(Object.values(users).some(u=>u.name===displayName)){
    alert('Name already taken in this room!');
    return;
  }
  const colors=['#f97316','#ef4444','#06b6d4','#8b5cf6','#10b981','#3b82f6','#ef9a7a','#f43f5e'];
  const usedColors=Object.values(users).map(u=>u.color);
  const color=colors.find(c=>!usedColors.includes(c))||'#000';
  await roomRef.child(`users/${uid}`).set({name:displayName,color});
  roomRef.child(`users/${uid}`).onDisconnect().remove();
  watchOnlineUsers();
}

function watchOnlineUsers(){
  const usersRef=db.ref(`rooms/${roomName}/users`);
  usersRef.on('value',snap=>{
    const users=snap.val()||{};
    onlineUsersEl.innerHTML='';
    Object.values(users).forEach(u=>{
      const userEl=document.createElement('div');
      userEl.className='user-avatar';
      const avatar=document.createElement('span');
      avatar.style.background=u.color;
      const name=document.createElement('span');
      name.textContent=u.name;
      userEl.appendChild(avatar);
      userEl.appendChild(name);
      onlineUsersEl.appendChild(userEl);
    });
  });
}

// Typing
function startTyping(){if(!uid) return;
  const tRef=db.ref(`typing/${roomName}/${uid}`);
  tRef.set({name:displayName,ts:Date.now()});
  if(typingTimeout) clearTimeout(typingTimeout);
  typingTimeout=setTimeout(()=>tRef.remove(),1500);
}
function watchTyping(){db.ref(`typing/${roomName}`).on('value',snap=>{
  const val=snap.val()||{};
  const names=Object.values(val).map(x=>x.name).filter(Boolean);
  typingEl.style.display=names.length?'block':'none';
  typingEl.textContent=names.length?names.join(', ')+' typing...':'';
});}

// Send message
function sendMessage(){
  const text=msgInput.value.trim();
  if(!text||!uid) return;
  const payload={name:displayName,text,ts:Date.now(),uid};
  if(replyTo) payload.reply=replyTo;
  const roomRef=db.ref(`rooms/${roomName}/messages`);
  if(editKey){
    roomRef.child(editKey).update({text});
    editKey=null;
  } else roomRef.push(payload);
  msgInput.value=''; replyTo=null; db.ref(`typing/${roomName}/${uid}`).remove();
}

// Listen messages
function listenRoom(){
  messagesEl.innerHTML='';
  const ref=db.ref(`rooms/${roomName}/messages`).limitToLast(200);
  ref.on('child_added',snap=>{
    const m=snap.val(); m.key=snap.key;
    const isMe=m.uid===uid;
    const el=document.createElement('div'); el.className='msg'+(isMe?' me':''); el.setAttribute('data-key',m.key);
    const color=colorForId(m.uid||m.name);
    el.innerHTML=`${m.reply?`<div class="reply-box"><strong>${m.reply.name}</strong>: ${m.reply.text}</div>`:''}
      <div class="meta"><span class="avatar" style="background:${color}"></span><strong>${m.name}</strong> ¬∑ ${new Date(m.ts).toLocaleTimeString()}</div>
      <div>${m.text}</div>
      <div style="margin-top:4px;">
        <button class="edit-btn">${isMe?'Edit':''}</button>
        <button class="delete-btn">${isMe?'Delete':''}</button>
      </div>`;
    if(isMe){
      el.querySelector('.edit-btn').addEventListener('click',()=>{msgInput.value=m.text; editKey=m.key; msgInput.focus();});
      el.querySelector('.delete-btn').addEventListener('click',()=>db.ref(`rooms/${roomName}/messages/${m.key}`).remove());
    } else el.querySelector('.delete-btn').style.display='none';
    el.addEventListener('click',()=>{replyTo={name:m.name,text:m.text}; msgInput.focus();});
    messagesEl.appendChild(el); messagesEl.scrollTop=messagesEl.scrollHeight;
  });
  ref.on('child_removed',snap=>{const removedKey=snap.key; const msgEl=messagesEl.querySelector(`[data-key="${removedKey}"]`); if(msgEl) messagesEl.removeChild(msgEl);});
}

// Event listeners
sendBtn.addEventListener('click',sendMessage);
msgInput.addEventListener('keydown',e=>{if(e.key==='Enter') sendMessage(); else startTyping();});
msgInput.addEventListener('input',startTyping);

roomInput.addEventListener('change',()=>{roomName=roomInput.value.trim()||'global'; roomNameEl.textContent=roomName; localStorage.setItem('roomName',roomName); joinRoom(); listenRoom(); watchTyping();});
nameInput.addEventListener('change',()=>{displayName=nameInput.value.trim(); displayNameEl.textContent=displayName; localStorage.setItem('displayName',displayName); joinRoom();});
clearBtn.addEventListener('click',()=>messagesEl.innerHTML='');

listenRoom(); watchTyping();
</script>
</body>
</html>
