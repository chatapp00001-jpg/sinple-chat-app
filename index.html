<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simple Chat</title>
  <style>
    body{font-family:Inter,system-ui,Arial;background:#f5f7fb;margin:0;padding:0;display:flex;align-items:center;justify-content:center;height:100vh}
    .app{width:100%;max-width:720px;height:90vh;background:#fff;border-radius:12px;box-shadow:0 6px 30px rgba(20,30,60,.08);display:flex;flex-direction:column;overflow:hidden}
    header{padding:14px 18px;border-bottom:1px solid #eef2f7;display:flex;align-items:center;gap:12px}
    header h1{font-size:16px;margin:0}
    #messages{flex:1;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:8px;background:linear-gradient(180deg,#f9fbff, #fff)}
    .msg{max-width:75%;padding:10px 12px;border-radius:10px;background:#eef6ff;border:1px solid rgba(0,60,120,.04);box-shadow:0 1px 0 rgba(0,0,0,.02)}
    .me{align-self:flex-end;background:#dff6e8;border-color:rgba(0,120,60,.06)}
    .meta{font-size:12px;opacity:.7;margin-bottom:6px}
    footer{padding:12px;border-top:1px solid #eef2f7;display:flex;gap:8px}
    input[type=text]{flex:1;padding:10px 12px;border-radius:8px;border:1px solid #e6edf6}
    button{padding:10px 12px;border-radius:8px;border:none;background:#2563eb;color:#fff;cursor:pointer}
    .small{font-size:12px;color:#6b7280}
    .controls{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Simple Chat (Firebase Realtime DB)</h1>
      <div style="margin-left:auto;display:flex;flex-direction:column;align-items:flex-end">
        <div class="small">Local name: <strong id="displayName">(not set)</strong></div>
        <div class="small">Room: <strong id="roomName">global</strong></div>
      </div>
    </header>

    <div id="messages"></div>

    <footer>
      <div style="display:flex;gap:8px;flex:1;align-items:center">
        <input id="nameInput" type="text" placeholder="Your display name (e.g. Sudu)" />
        <input id="roomInput" type="text" placeholder="Room name (default: global)" />
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <input id="msgInput" type="text" placeholder="Type a message and press Enter" style="min-width:220px" />
        <div style="display:flex;gap:6px"><button id="sendBtn">Send</button><button id="clearBtn" style="background:#ef4444">Clear</button></div>
      </div>
    </footer>
  </div>

  <!-- Firebase JS (compat) CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB1kH5ViWhVpwJMaQEY0mcJhtEOia1k2aE",
      authDomain: "chat-2d825.firebaseapp.com",
      databaseURL:"https://chat-2d825-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "chat-2d825",
      storageBucket: "chat-2d825.firebasestorage.app",
      messagingSenderId: "397345569962",
      appId: "1:397345569962:web:bac031c0cf9a394820a4d3",
      measurementId: "G-YVDC4J0CM5"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    // DOM Elements
    const msgInput = document.getElementById('msgInput');
    const nameInput = document.getElementById('nameInput');
    const roomInput = document.getElementById('roomInput');
    const messagesEl = document.getElementById('messages');
    const displayNameEl = document.getElementById('displayName');
    const roomNameEl = document.getElementById('roomName');

    // Local storage defaults
    let displayName = localStorage.getItem('displayName') || '';
    let roomName = localStorage.getItem('roomName') || 'global';
    nameInput.value = displayName;
    roomInput.value = roomName;
    displayNameEl.textContent = displayName || '(not set)';
    roomNameEl.textContent = roomName;

    // Anonymous Auth
    auth.onAuthStateChanged(user => {
      if (!user) {
        auth.signInAnonymously().catch(err => console.error('Auth failed', err));
      }
    });

    // Send message
    function sendMessage(){
      const text = msgInput.value.trim();
      if(!text) return;
      displayName = nameInput.value.trim() || 'Anonymous';
      roomName = roomInput.value.trim() || 'global';
      localStorage.setItem('displayName', displayName);
      localStorage.setItem('roomName', roomName);
      displayNameEl.textContent = displayName;
      roomNameEl.textContent = roomName;

      const payload = { name: displayName, text: text, ts: Date.now() };
      const ref = db.ref('rooms/' + roomName + '/messages');
      ref.push(payload, err => { if(err) console.error('Write failed', err); });
      msgInput.value = '';
    }

    sendBtn.addEventListener('click', sendMessage);
    msgInput.addEventListener('keydown', e => { if(e.key==='Enter') sendMessage(); });

    // Listen messages
    function listenRoom(room){
      messagesEl.innerHTML='';
      const ref = db.ref('rooms/' + room + '/messages').limitToLast(200);
      ref.on('child_added', snapshot => {
        const m = snapshot.val();
        const el = document.createElement('div');
        el.className = 'msg' + ((m.name===displayName)?' me':'');
        el.innerHTML = `<div class="meta">${m.name} Â· ${new Date(m.ts).toLocaleTimeString()}</div><div>${m.text}</div>`;
        messagesEl.appendChild(el);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });
    }

    listenRoom(roomName);

    // Room change listener
    roomInput.addEventListener('change', ()=>{ roomName = roomInput.value.trim() || 'global'; localStorage.setItem('roomName', roomName); listenRoom(roomName); });
    nameInput.addEventListener('change', ()=>{ displayName = nameInput.value.trim() || 'Anonymous'; localStorage.setItem('displayName', displayName); displayNameEl.textContent = displayName; });

    // Clear chat locally
    clearBtn.addEventListener('click', ()=>{ messagesEl.innerHTML=''; });
  </script>
</body>
</html>