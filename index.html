<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#2563eb">
<link rel="icon" href="chat.png" type="image/png" />
<link rel="manifest" href="manifest.json">
<title>Easy Chat</title>

<style>
body {
  font-family: Inter, system-ui, Arial;
  background:#f5f7fb;
  margin:0;
  padding:16px;
  display:flex;
  align-items:center;
  justify-content:center;
  min-height:100vh;
  transition:.3s;
}
body.dark{background:#121212;color:#e0e0e0}

.app{
  width:100%;
  max-width:720px;
  background:#fff;
  border-radius:12px;
  box-shadow:0 6px 30px rgba(20,30,60,.08);
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
body.dark .app{background:#1e1e1e}

header{
  padding:12px 16px;
  border-bottom:1px solid #eef2f7;
}
body.dark header{border-color:#333}

.meta-bar{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  font-size:12px;
  align-items:center;
}

#messages{
  height:55vh;
  overflow:auto;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:8px;
  background:linear-gradient(180deg,#f9fbff,#fff);
}
body.dark #messages{
  background:linear-gradient(180deg,#2a2a2a,#1e1e1e);
}

.msg{
  max-width:75%;
  padding:10px 12px;
  border-radius:10px;
  background:#eef6ff;
}
.me{align-self:flex-end;background:#dff6e8}
body.dark .msg{background:#2a2a2a}
body.dark .me{background:#3a3a3a}

.meta{font-size:12px;opacity:.7;margin-bottom:4px}

footer{
  padding:12px;
  border-top:1px solid #eef2f7;
  display:flex;
  flex-direction:column;
  gap:8px;
}
body.dark footer{border-color:#333}

input[type="text"],
input[type="password"],
button{
  padding:10px 12px;
  border-radius:8px;
  border:1px solid #e6edf6;
  font-size:14px;
  outline:none;
}

body.dark input,
body.dark button{
  background:#2a2a2a;
  color:#e0e0e0;
  border-color:rgba(255,255,255,.2);
}

button{
  background:#2563eb;
  color:#fff;
  cursor:pointer;
}

.small{font-size:12px;color:#6b7280}
body.dark .small{color:#c0c0c0}

.typing{font-size:13px;color:#475569}
body.dark .typing{color:#aaa}

@media(max-width:480px){
  #messages{height:50vh}
}
</style>
</head>

<body>

<div class="app">
<header>
  <h1>Easy Chat</h1>
  <div class="meta-bar">
    <div class="small">Name: <strong id="displayName">(not set)</strong> <span id="nameLockIcon" style="display:none">üîê</span></div>
    <div class="small">Room: <strong id="roomName">global</strong></div>
    <div class="small" style="width:100%">Version: <strong id="appVersion">‚Äì</strong></div>
    <div id="onlineUsers"></div>
    <div class="typing" id="typingEl" style="display:none"></div>
    <button id="darkModeBtn">üåô</button>
    <button id="leaveRoomBtn">üö™</button>
  </div>
</header>

<div id="messages"></div>

<footer>
  <div style="display:flex;gap:8px">
    <input id="nameInput" type="text" placeholder="Your name">
    <input id="roomInput" type="text" placeholder="Room name">
    <input id="roomPassInput" type="password" placeholder="Room password (optional)">
  </div>
  <div style="display:flex;gap:6px">
    <input id="msgInput" type="text" placeholder="Type message">
    <button id="sendBtn">Send</button>
    <button id="clearBtn" style="background:#ef4444">Clear</button>
  </div>
</footer>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig={
 apiKey:"AIzaSyB1kH5ViWhVpwJMaQEY0mcJhtEOia1k2aE",
 authDomain:"chat-2d825.firebaseapp.com",
 databaseURL:"https://chat-2d825-default-rtdb.asia-southeast1.firebasedatabase.app",
 projectId:"chat-2d825"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();
const auth=firebase.auth();

const nameInput=nameInput=document.getElementById("nameInput");
const roomInput=document.getElementById("roomInput");
const roomPassInput=document.getElementById("roomPassInput");
const msgInput=document.getElementById("msgInput");
const messagesEl=document.getElementById("messages");
const displayNameEl=document.getElementById("displayName");
const roomNameEl=document.getElementById("roomName");
const sendBtn=document.getElementById("sendBtn");
const clearBtn=document.getElementById("clearBtn");
const darkBtn=document.getElementById("darkModeBtn");
const leaveBtn=document.getElementById("leaveRoomBtn");
const typingEl=document.getElementById("typingEl");
const lockIcon=document.getElementById("nameLockIcon");

let roomName=localStorage.getItem("roomName")||"global";
let displayName=localStorage.getItem("displayName")||"";
let uid=null;

displayNameEl.textContent=displayName||"(not set)";
roomNameEl.textContent=roomName;

auth.onAuthStateChanged(u=>{if(!u)auth.signInAnonymously();else uid=u.uid});

function hashPassword(s){
 let h=0;for(let i=0;i<s.length;i++)h=(h<<5)-h+s.charCodeAt(i);return h+"";
}

roomInput.addEventListener("change",()=>{
 const r=roomInput.value.trim()||"global";
 const p=roomPassInput.value.trim();
 const ref=db.ref("rooms_meta/"+r);
 ref.once("value",snap=>{
  const d=snap.val();
  if(d?.private && hashPassword(p)!==d.password){
    alert("Wrong password");roomInput.value=roomName;return;
  }
  if(!d && p)ref.set({private:true,password:hashPassword(p)});
  roomName=r;
  roomNameEl.textContent=r+(d?.private||p?" üîí":"");
  localStorage.setItem("roomName",roomName);
  messagesEl.innerHTML="";
  listenRoom(roomName);
 });
});

function listenRoom(r){
 db.ref("rooms/"+r+"/messages").limitToLast(200)
 .on("child_added",s=>{
  const m=s.val();
  const d=document.createElement("div");
  d.className="msg";
  d.textContent=m.name+": "+m.text;
  messagesEl.appendChild(d);
  messagesEl.scrollTop=messagesEl.scrollHeight;
 });
}

sendBtn.onclick=()=>{
 const t=msgInput.value.trim();
 if(!t)return;
 db.ref("rooms/"+roomName+"/messages").push({name:displayName||"Anon",text:t});
 msgInput.value="";
};

clearBtn.onclick=()=>messagesEl.innerHTML="";
darkBtn.onclick=()=>document.body.classList.toggle("dark");

listenRoom(roomName);
</script>

</body>
</html>
