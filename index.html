<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Easy Chat</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">

<style>
body{font-family:Inter,Arial;background:#f5f7fb;margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh}
.app{width:100%;max-width:720px;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.1);display:flex;flex-direction:column;overflow:hidden}
header,footer{padding:12px;border-bottom:1px solid #eee}
footer{border-top:1px solid #eee}
#messages{flex:1;overflow:auto;padding:12px}
.msg{background:#eef6ff;padding:10px;border-radius:8px;margin-bottom:8px}
.me{background:#dff6e8}
input,button{padding:8px;border-radius:6px;border:1px solid #ddd}
button{background:#2563eb;color:#fff;cursor:pointer}
.small{font-size:12px;color:#555}
</style>
</head>

<body>

<div class="app">
<header>
  <strong>Easy Chat</strong>
  <div class="small">
    Room: <span id="roomName">global</span>
  </div>
  <div class="small">
    Version: <span id="appVersion">‚Äì</span>
  </div>
</header>

<div id="messages"></div>

<footer>
  <input id="nameInput" placeholder="Your name"/>
  <input id="roomInput" placeholder="Room name"/>
  <input id="roomPassInput" type="password" placeholder="Room password (optional)"/>
  <input id="msgInput" placeholder="Type message"/>
  <button id="sendBtn">Send</button>
</footer>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<script>
/* üî• FIREBASE CONFIG */
firebase.initializeApp({
  apiKey: "AIzaSyB1kH5ViWhVpwJMaQEY0mcJhtEOia1k2aE",
  authDomain: "chat-2d825.firebaseapp.com",
  databaseURL: "https://chat-2d825-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "chat-2d825",
});

const db = firebase.database();
firebase.auth().signInAnonymously();

const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const messagesEl = document.getElementById("messages");
const roomInput = document.getElementById("roomInput");
const roomPassInput = document.getElementById("roomPassInput");
const roomNameEl = document.getElementById("roomName");
const nameInput = document.getElementById("nameInput");

let roomName = "global";
let uid = null;

firebase.auth().onAuthStateChanged(u => uid = u.uid);

/* üîê HASH PASSWORD */
function hashPassword(str){
  let h=0; for(let i=0;i<str.length;i++) h=(h<<5)-h+str.charCodeAt(i);
  return h.toString();
}

/* üåç JOIN / CREATE ROOM */
roomInput.addEventListener("change", () => {
  const newRoom = roomInput.value.trim() || "global";
  const pass = roomPassInput.value.trim();
  const metaRef = db.ref("rooms_meta/"+newRoom);

  metaRef.once("value", snap => {
    const data = snap.val();

    if (data && data.private) {
      if (!pass || hashPassword(pass) !== data.password) {
        alert("üîí Wrong or missing password");
        roomInput.value = roomName;
        return;
      }
    }

    if (!data && pass) {
      metaRef.set({
        private: true,
        password: hashPassword(pass),
        createdAt: Date.now()
      });
    }

    roomName = newRoom;
    roomNameEl.textContent = roomName + (data?.private ? " üîí" : "");
    messagesEl.innerHTML = "";
    listenRoom();
    roomPassInput.value = "";
  });
});

/* üí¨ SEND MESSAGE */
sendBtn.onclick = () => {
  if (!msgInput.value) return;
  db.ref("rooms/"+roomName+"/messages").push({
    name: nameInput.value || "Anonymous",
    text: msgInput.value,
    ts: Date.now(),
    uid
  });
  msgInput.value = "";
};

/* üì° LISTEN MESSAGES */
function listenRoom(){
  db.ref("rooms/"+roomName+"/messages").off();
  db.ref("rooms/"+roomName+"/messages")
    .limitToLast(100)
    .on("child_added", snap => {
      const m = snap.val();
      const div = document.createElement("div");
      div.className = "msg" + (m.uid === uid ? " me" : "");
      div.innerHTML = `<strong>${m.name}</strong><br>${m.text}`;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });
}

listenRoom();

/* üì¶ SERVICE WORKER VERSION */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js").then(() => {
    navigator.serviceWorker.ready.then(r => {
      r.active.postMessage({type:"GET_VERSION"});
    });
  });

  navigator.serviceWorker.addEventListener("message", e => {
    if (e.data?.version) {
      document.getElementById("appVersion").textContent = e.data.version;
    }
  });
}
</script>
</body>
</html>
