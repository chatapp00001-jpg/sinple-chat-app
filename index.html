<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Easy Chat</title>

<style>
body{
  font-family: Inter, system-ui, Arial;
  background:#f5f7fb;
  margin:0;
  padding:16px;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
.app{
  width:100%;
  max-width:720px;
  background:#fff;
  border-radius:12px;
  box-shadow:0 6px 30px rgba(0,0,0,.08);
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
header{
  padding:12px 16px;
  border-bottom:1px solid #e5e7eb;
}
.meta-bar{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  font-size:12px;
}
#messages{
  height:60vh;
  overflow:auto;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.msg{
  max-width:75%;
  padding:10px 12px;
  border-radius:10px;
  background:#eef6ff;
}
.me{
  align-self:flex-end;
  background:#dff6e8;
}
.meta{
  font-size:12px;
  opacity:.7;
  margin-bottom:4px;
}
footer{
  padding:12px;
  border-top:1px solid #e5e7eb;
  display:flex;
  flex-direction:column;
  gap:8px;
}
input,button{
  padding:10px;
  border-radius:8px;
  border:1px solid #d1d5db;
}
button{
  background:#2563eb;
  color:#fff;
  cursor:pointer;
}
button:disabled{
  background:#9ca3af;
  cursor:not-allowed;
}
#nameError{
  color:red;
  font-size:12px;
  display:none;
}
</style>
</head>

<body>
<div class="app">

<header>
  <div class="meta-bar">
    <div>Name: <strong id="displayName">(not set)</strong></div>
    <div>Room: <strong id="roomName">global</strong></div>
  </div>
</header>

<div id="messages"></div>

<footer>
  <input id="nameInput" type="text" placeholder="Your name" />
  <div id="nameError">This name already exists in this room</div>

  <input id="roomInput" type="text" placeholder="Room name (default global)" />
  <input id="msgInput" type="text" placeholder="Type message" disabled />

  <button id="sendBtn" disabled>Send</button>
</footer>

</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<script>
// ðŸ”¥ Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyB1kH5ViWhVpwJMaQEY0mcJhtEOia1k2aE",
  authDomain: "chat-2d825.firebaseapp.com",
  databaseURL: "https://chat-2d825-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "chat-2d825",
  storageBucket: "chat-2d825.appspot.com",
  messagingSenderId: "397345569962",
  appId: "1:397345569962:web:bac031c0cf9a394820a4d3"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

// Elements
const msgInput = document.getElementById('msgInput');
const nameInput = document.getElementById('nameInput');
const roomInput = document.getElementById('roomInput');
const sendBtn = document.getElementById('sendBtn');
const messagesEl = document.getElementById('messages');
const displayNameEl = document.getElementById('displayName');
const roomNameEl = document.getElementById('roomName');
const nameError = document.getElementById('nameError');

let uid = null;
let displayName = '';
let roomName = 'global';
let canSendMessage = false;

// Auth
auth.onAuthStateChanged(user=>{
  if(!user){
    auth.signInAnonymously();
  }else{
    uid = user.uid;
  }
});

// ðŸ” Check name unique
async function checkNameUnique(room, uid, name){
  const snap = await db.ref(`rooms/${room}/users`).get();
  const users = snap.val() || {};
  for(let id in users){
    if(users[id].name === name && id !== uid){
      return false;
    }
  }
  return true;
}

// Name input
nameInput.addEventListener('input', async ()=>{
  displayName = nameInput.value.trim();
  if(!displayName || !uid) return;

  displayNameEl.textContent = displayName;

  const unique = await checkNameUnique(roomName, uid, displayName);

  if(!unique){
    canSendMessage = false;
    sendBtn.disabled = true;
    msgInput.disabled = true;
    nameError.style.display = 'block';
  }else{
    canSendMessage = true;
    sendBtn.disabled = false;
    msgInput.disabled = false;
    nameError.style.display = 'none';

    db.ref(`rooms/${roomName}/users/${uid}`).set({
      name: displayName
    });
  }
});

// Room change
roomInput.addEventListener('change', ()=>{
  roomName = roomInput.value.trim() || 'global';
  roomNameEl.textContent = roomName;

  messagesEl.innerHTML='';
  canSendMessage = false;
  sendBtn.disabled = true;
  msgInput.disabled = true;

  listenMessages();
});

// Send message
function sendMessage(){
  if(!canSendMessage) return;

  const text = msgInput.value.trim();
  if(!text) return;

  db.ref(`rooms/${roomName}/messages`).push({
    name: displayName,
    text,
    uid,
    ts: Date.now()
  });

  msgInput.value='';
}

sendBtn.addEventListener('click', sendMessage);
msgInput.addEventListener('keydown', e=>{
  if(e.key==='Enter') sendMessage();
});

// Listen messages
function listenMessages(){
  db.ref(`rooms/${roomName}/messages`).limitToLast(100)
    .on('child_added', snap=>{
      const m = snap.val();
      const el = document.createElement('div');
      el.className = 'msg' + (m.uid===uid?' me':'');
      el.innerHTML = `
        <div class="meta">${m.name}</div>
        <div>${m.text}</div>
      `;
      messagesEl.appendChild(el);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });
}

listenMessages();
</script>
</body>
</html>
